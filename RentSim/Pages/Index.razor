@*@using Processing;
@using Processing.Assets;
@using Processing.Withdrawal; *@
@using System.Globalization;
@using Domain;
@using Finance.Results
@using Protocol;
@using Strategy;
@using Portfolio;
@using Finance;
@using System.Collections.ObjectModel

@page "/"

<Divider DividerType="DividerType.TextContent" Text="Timeline Data"></Divider>

<Field Horizontal="true">

    <FieldLabel ColumnSize="ColumnSize.Is1">Current Age:</FieldLabel>
    <Age @bind-Value="@lifeAssumptions.ageCurrent" Lower="0" @bind-Upper="@lifeAssumptions.ageStopWork"/>

    <FieldLabel ColumnSize="ColumnSize.Is1">Stop Work Age:</FieldLabel>
    <Age @bind-Value="@lifeAssumptions.ageStopWork" @bind-Lower="lifeAssumptions.ageCurrent" @bind-Upper="@lifeAssumptions.ageRentStart" />

    <FieldLabel ColumnSize="ColumnSize.Is1">Rent Start Age:</FieldLabel>
    <Age @bind-Value="@lifeAssumptions.ageRentStart" @bind-Lower="lifeAssumptions.ageStopWork" @bind-Upper="@lifeAssumptions.ageEnd"/>

    <FieldLabel ColumnSize="ColumnSize.Is1">End Age:</FieldLabel>
    <Age @bind-Value="@lifeAssumptions.ageEnd" @bind-Lower="lifeAssumptions.ageRentStart" Upper="100"/>

    <FieldLabel ColumnSize="ColumnSize.Is1"></FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1">
    </FieldBody>

    @*I would say we introduce a switch to switch between good case and bad case*@

@*    <FieldLabel ColumnSize="ColumnSize.Is1">Interest Rate Type:</FieldLabel>
    <FieldBody>
        <RadioGroup ColumnSize="ColumnSize.Is1" TValue="InterestRateType" Name="InterestRateType" Buttons="true" Color="Color.Light" CheckedValue="@interestRateType" CheckedValueChanged="@OnInterestRateCheckedValueChanged">
            <Radio TValue="InterestRateType" Value="@InterestRateType.Relativ">Relativ</Radio>
            <Radio TValue="InterestRateType" Value="@InterestRateType.Konform">Konform</Radio>
        </RadioGroup>
    </FieldBody>

    @code {
        InterestRateType interestRateType = InterestRateType.Relativ;

        async void OnInterestRateCheckedValueChanged(InterestRateType value)
        {
            interestRateType = value;
            await HandleRedraw();
        }
    }*@
 </Field>




<Divider DividerType="DividerType.TextContent" Text="Initial Assets"></Divider>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Cash:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.cash" DelayTextOnKeyPress="false" Step="1000" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Cash Interest Rate (%):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.cashGrowthRate" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Monthly Cash Save Amount:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.cashSaveAmountPerMonth" DelayTextOnKeyPress="false" /> </FieldBody>
</Field>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Stocks:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.stocks" DelayTextOnKeyPress="false" Step="1000" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Stocks Growth Rate (%):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.stocksGrowthRate" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Monthly Stocks Save Amount:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.stocksSaveAmountPerMonth" DelayTextOnKeyPress="false" /> </FieldBody>
</Field>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Metals:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.metals" DelayTextOnKeyPress="false" Step="1000" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Metals Growth Rate (%):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.metalsGrowthRate" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Monthly Metals Save Amount:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit @bind-Value="@lifeAssumptions.metalsSaveAmountPerMonth" DelayTextOnKeyPress="false" /> </FieldBody>
</Field>









<Divider DividerType="DividerType.TextContent" Text="Rent Approximations"></Divider>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Net State Rent (work until @lifeAssumptions.ageCurrent):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="decimal" @bind-Value="@lifeAssumptions.netStateRentFromCurrentAge_perMonth" DelayTextOnKeyPress="false" Step=100m /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Net State Rent (work until @lifeAssumptions.ageRentStart):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="decimal" @bind-Value="@lifeAssumptions.netStateRentFromRentStartAge_perMonth" DelayTextOnKeyPress="false" Step=100m /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Net State Rent (work until @lifeAssumptions.ageStopWork):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@FieldNetRentAgeFromStopWork_perMonth" DelayTextOnKeyPress="false"/> </FieldBody>
</Field>




@*//you cannot do bind-value and @onchange same time
https://stackoverflow.com/questions/60660371/why-would-the-onchange-event-of-inputtext-not-fire-in-blazor
*@



<Divider DividerType="DividerType.TextContent" Text="Need Approximations"></Divider>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Needs now Minimum:</FieldLabel>
    @*<FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="decimal" @bind-Value="@lifeAssumptions.needsCurrentAgeMinimal" DelayTextOnKeyPress="false" Step=100m ValueChanged="HandleRedraw()" /> </FieldBody>*@
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="decimal" @bind-Value="@lifeAssumptions.needsCurrentAgeMinimal" onchange="@HandleRedraw" DelayTextOnKeyPress="false" Step=100m /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Needs now Comfort:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="decimal" @bind-Value="@lifeAssumptions.needsCurrentAgeComfort" onchange="@HandleRedraw" DelayTextOnKeyPress="false" Step=100m /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Inflation Rate:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <NumericEdit TValue="double" @bind-Value="@lifeAssumptions.inflationRate" onchange="@HandleRedraw" DelayTextOnKeyPress="false" Step=0.01m /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Needs Rent Start Minimum:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true"  @bind-Text="@FieldNeedsRentStartMinimum_perMonth" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Needs Rent Start Comfort:</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true"  @bind-Text="@FieldNeedsRentStartComfort_perMonth" DelayTextOnKeyPress="false" /> </FieldBody>

</Field>










<Divider DividerType="DividerType.TextContent" Text="Results"></Divider>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Total Savings at @lifeAssumptions.ageStopWork</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@FieldResultsTotalSavingStopWorkAge" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Net Rate (@lifeAssumptions.ageStopWork - @lifeAssumptions.ageRentStart):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@FieldResultsRatePhaseStopWork" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Net Rate (@lifeAssumptions.ageRentStart - @lifeAssumptions.ageEnd):</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@FieldResultsRatePhaseRent" DelayTextOnKeyPress="false" /> </FieldBody>
</Field>





<Divider DividerType="DividerType.TextContent" Text="Rent Phase"></Divider>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Savings Needed: </FieldLabel>

    <FieldLabel ColumnSize="ColumnSize.Is1">Cash </FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_SavingsNeededCash" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Stocks</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_SavingsNeededStocks" DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Total</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_SavingsNeededTotal" DelayTextOnKeyPress="false" /> </FieldBody>
</Field>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Good Case: </FieldLabel>

    <FieldLabel ColumnSize="ColumnSize.Is1">Rate Cash pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_GoodCase_RateCash"  DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Rate Stocks pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_GoodCase_RateStocks"  DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Taxes pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_GoodCase_Taxes"  DelayTextOnKeyPress="false" /> </FieldBody>
</Field>

<Field Horizontal="true">
    <FieldLabel ColumnSize="ColumnSize.Is1">Bad Case: </FieldLabel>

    <FieldLabel ColumnSize="ColumnSize.Is1">Rate Cash pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_BadCase_RateCash"  DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Rate Stocks pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_BadCase_RateStocks"  DelayTextOnKeyPress="false" /> </FieldBody>

    <FieldLabel ColumnSize="ColumnSize.Is1">Taxes pY</FieldLabel>
    <FieldBody ColumnSize="ColumnSize.Is1"> <TextEdit ReadOnly="true" @bind-Text="@Field_RentPhaseResult_BadCase_Taxes"  DelayTextOnKeyPress="false" /> </FieldBody>
</Field>



@*<Button Clicked="@(async () => await HandleRedraw())">Redraw</Button>
<Button Clicked="@(async () => await LoaderDefault())">LoadDefault</Button>*@

<Row>
    <Column ColumnSize="ColumnSize.Is4">
        <LineChart @ref="lineChart" TItem="double"/>
    </Column>
   <Column ColumnSize="ColumnSize.Is4">
        <BarChart @ref="barChart" TItem="decimal" OptionsObject="@dataBarChartOptions" />
    </Column>

</Row>





<DataGrid TItem="ResultRow"
          Narrow="true"
          Data="@resultRows"
          ReadData="@OnReadData"
          TotalItems="@totalRows">
    <DataGridCommandColumn TItem="ResultRow" />
    
    <DataGridColumn TItem="ResultRow" Field="age" Caption="Age" Sortable="false" TextAlignment=TextAlignment.End  HeaderTextAlignment=TextAlignment.End>
    </DataGridColumn>

    <DataGridColumn TItem="ResultRow" Field="TotalYearBegin" Caption="Total Year Begin" Sortable="false" TextAlignment=TextAlignment.End HeaderTextAlignment=TextAlignment.End DisplayFormat="{0,12:C0}" DisplayFormatProvider="@System.Globalization.CultureInfo.GetCultureInfo("de-DE")"/>
        
    @*<DataGridColumn TItem="ResultRow" Field="deposits" Caption="Deposits" Sortable="false" TextAlignment=TextAlignment.End  HeaderTextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.deposits)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="interests" Caption="Interests" Sortable="false" TextAlignment=TextAlignment.End  HeaderTextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.interests)) </DisplayTemplate>
    </DataGridColumn>*@
    <DataGridColumn TItem="ResultRow" Field="TotalYearEnd" Caption="Total Year End" Sortable="false" TextAlignment=TextAlignment.End  HeaderTextAlignment=TextAlignment.End DisplayFormat="{0,12:C0}" DisplayFormatProvider="@System.Globalization.CultureInfo.GetCultureInfo("de-DE")"/>
    @*<DataGridColumn TItem="ResultRow" Field="cash.yearBegin" Caption="cash.yearBegin" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.cash.yearBegin)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="metals.yearBegin" Caption="metals.yearBegin" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.metals.yearBegin)) </DisplayTemplate>
    </DataGridColumn>

    <DataGridColumn TItem="ResultRow" Field="total.invests" Caption="total.invests" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.total.invests)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="stocks.invests" Caption="stocks.invests" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.stocks.invests)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="cash.invests" Caption="cash.invests" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.cash.invests)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="metals.invests" Caption="metals.invests" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.metals.invests)) </DisplayTemplate>
    </DataGridColumn>

    <DataGridColumn TItem="ResultRow" Field="stocks.growth" Caption="stocks.growth" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.stocks.growth)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="cash.growth" Caption="cash.growth" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.cash.growth)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="metals.growth" Caption="metals.growth" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.metals.growth)) </DisplayTemplate>
    </DataGridColumn>

    <DataGridColumn TItem="ResultRow" Field="total.yearEnd" Caption="total.yearEnd" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.total.yearEnd)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="stocks.yearEnd" Caption="stocks.yearEnd" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.stocks.yearEnd)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="cash.yearEnd" Caption="cash.yearEnd" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.cash.yearEnd)) </DisplayTemplate>
    </DataGridColumn>
    <DataGridColumn TItem="ResultRow" Field="metals.yearEnd" Caption="metals.yearEnd" Sortable="false" TextAlignment=TextAlignment.End>
        <DisplayTemplate> @(BeautifyToCurrenctWith0Decimals((context as ResultRow)?.metals.yearEnd)) </DisplayTemplate>
    </DataGridColumn>*@

</DataGrid>


@code
{
    int totalRows;

    async Task OnReadData(DataGridReadDataEventArgs<ResultRow> e)
    {
        // this is used to tell datagrid how many items are available so that pagination will work
        totalRows = resultRows != null
            ? resultRows.Count()
            : 0;

        // always call StateHasChanged!
        StateHasChanged();

        await Task.Delay(0);
    }

    public string BeautifyToCurrenctWith2Decimals(decimal? num)
    {
        return string.Format(CultureInfo.CreateSpecificCulture("de-DE"), "{0,12:C2}", num);
    }

    public string BeautifyToCurrenctWith0Decimals(decimal? num)
    {
        return string.Format(CultureInfo.CreateSpecificCulture("de-DE"), "{0,12:C0}", num);
    }
}




@code{
    LineChart<double> lineChart;
    BarChart<decimal> barChart;
    BarChartOptions dataBarChartOptions;
    LineChartOptions dataLineChartOptions;
    ChartScales myScales;
    //ResultSet resultSet;
    IEnumerable<ResultRow> resultRows;
    //Portfolio portfolio = null;

    //MarketAssumptions marketAssumptions = new();
    LifeAssumptions lifeAssumptions = new();
    //NetRentResultData myNetRentResultData = new();
    RentPhaseResult myRentPhaseResult = new();
    StateRentResult myStateRentResult = new();
    LaterNeedsResult myLaterNeedsResult = new();

    //Inflation myRentStartInflation;


    string myStackedOptions = "{\"scales\": {\"xAxes\": [{\"stacked\": true}],\"yAxes\": [{\"stacked\": true}]}}";

    //int FieldAgeCurrent;
    //int FieldAgeStopWork;
    //int FieldAgeRentStart;
    //int FieldAgeEnd;


    //int FieldStocks;
    //int FieldStocksGrowthRate;
    //int FieldStocksSaveAmount;

    //int FieldCash;
    //int FieldCashGrowthRate;
    //int FieldCashSaveAmount;

    //int FieldMetals;
    //int FieldMetalsGrowthRate;
    //int FieldMetalsSaveAmount;

    //int FieldNetStateRentFromCurrentAge;
    //int FieldNetStateRentFromRentStartAge;

    //int FieldNeedsNowMinimum;
    //int FieldNeedsNowComfort;
    //int FieldInflationRate;

    //string Field_RentPhaseResult_RateCash {
    //    get
    //    { 
    //        return BeautifyToCurrenctWith0Decimals(myRentPhaseResult.rate_Cash);    
    //    }
    //    set { }
    //}






    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // RESULT DATA
    string Field_RentPhaseResult_GoodCase_RateCash;
    string Field_RentPhaseResult_GoodCase_RateStocks;
    string Field_RentPhaseResult_GoodCase_Taxes;
    string Field_RentPhaseResult_BadCase_RateCash;
    string Field_RentPhaseResult_BadCase_RateStocks;
    string Field_RentPhaseResult_BadCase_Taxes;
    string Field_RentPhaseResult_SavingsNeededCash;
    string Field_RentPhaseResult_SavingsNeededStocks;
    string Field_RentPhaseResult_SavingsNeededTotal;
    string FieldNeedsRentStartMinimum_perMonth;
    string FieldNeedsRentStartComfort_perMonth;

    string FieldResultsTotalSavingStopWorkAge;
    string FieldResultsNetStateRent;
    string FieldResultsRatePhaseRent;
    string FieldResultsRatePhaseStopWork;

    string FieldNetRentAgeFromStopWork_perMonth;

    protected override void OnAfterRender(bool firstRender)
    {
        // execute conditionally for loading data, otherwise this will load
        // every time the page refreshes
        if(firstRender)
        {
            // Do work to load page data and set properties
            HandleRedraw();
        }
    }

    //async Task HandleRedraw()
    public void HandleRedraw()
    {
        Console.WriteLine("SH: HandleRedraw");
        //Input input = new Input();
        //input.ageCurrent = FieldAgeCurrent;
        //input.ageStopWork = FieldAgeStopWork;
        //input.ageRentStart = FieldAgeRentStart;
        //input.ageEnd = FieldAgeEnd;

        //input.interestRateType = interestRateType;

        //input.stocks = FieldStocks;
        //input.stocksGrowthRate = FieldStocksGrowthRate;
        //input.stocksMonthlyInvestAmount = FieldStocksSaveAmount;

        //input.cash = FieldCash;
        //input.cashGrowthRate = FieldCashGrowthRate;
        //input.cashMonthlyInvestAmount = FieldCashSaveAmount;

        //input.metals = FieldMetals;
        //input.metalsGrowthRate = FieldMetalsGrowthRate;
        //input.metalsMonthlyInvestAmount = FieldMetalsSaveAmount;

        //input.netStateRentFromCurrentAge = FieldNetStateRentFromCurrentAge;
        //input.netStateRentFromRentStartAge = FieldNetStateRentFromRentStartAge;

        //input.NeedsNowMinimum = FieldNeedsNowMinimum;
        //input.NeedsNowComfort = FieldNeedsNowComfort;

        //FieldNeedsRentStartMinimum = BeautifyToCurrenctWith0Decimals(RentSimMath.InflationAdjusted(input.ageCurrent, input.ageRentStart, FieldNeedsNowMinimum, FieldInflationRate));
        //FieldNeedsRentStartComfort = BeautifyToCurrenctWith0Decimals(RentSimMath.InflationAdjusted(input.ageCurrent, input.ageRentStart, FieldNeedsNowComfort, FieldInflationRate));


        //Age.SetCurrent(lifeAssumptions.ageCurrent);



        var portfolio = new AssetPortfolio(lifeAssumptions);

        //var savingStrategy = new SavingStrategy(
        //    portfolio,
        //    lifeAssumptions,
        //    protocolWriter);

        //savingStrategy.Process();

        //NetRentInputData netRentInputData = lifeAssumptions.NetRent;
        //myNetRentResultData = RentCalculator.ApproxNetRent(
        //    netRentInputData.AgeCurrent,
        //    netRentInputData.NetRentAgeCurrent,
        //    netRentInputData.AgeRentStart,
        //    netRentInputData.NetRentAgeRentStart,
        //    netRentInputData.AgeStopWork
        //);

        //todo: this is diuplicated code 
        myStateRentResult = RentCalculator.ApproxStateRent(
            lifeAssumptions.ageCurrent,
            lifeAssumptions.netStateRentFromCurrentAge_perMonth,
            lifeAssumptions.ageRentStart,
            lifeAssumptions.netStateRentFromRentStartAge_perMonth,
            lifeAssumptions.ageStopWork
        );

        myLaterNeedsResult = RentCalculator.CalculateLaterNeeds(
            lifeAssumptions.ageCurrent,
            lifeAssumptions.ageRentStart,
            lifeAssumptions.inflationRate,
            lifeAssumptions.needsCurrentAgeMinimal,
            lifeAssumptions.needsCurrentAgeComfort,
            myStateRentResult.assumedStateRent_FromStopWorkAge_PerMonth
        );

        myRentPhaseResult = FinanceCalculator.CalculateRentPhaseResult(
            lifeAssumptions.rentPhase_InterestRate_Stocks_GoodCase,
            lifeAssumptions.rentPhase_InterestRate_Stocks_BadCase,
            lifeAssumptions.rentPhase_InterestRate_Cash,
            lifeAssumptions.ageEnd - lifeAssumptions.ageRentStart,
            myLaterNeedsResult.needsComfort_AgeRentStart_WithInflation_PerYear,
            myLaterNeedsResult.needsMinimum_AgeRentStart_WithInflation_PerYear,
            lifeAssumptions.rentPhase_CrashFactor_Stocks_BadCase,
            lifeAssumptions.taxFactor_Stocks
        );

        IProtocolWriter protocolWriter = new MemoryProtocolWriter();
        RentCalculator.Simulate(
                    lifeAssumptions.ageRentStart,
                    lifeAssumptions.ageEnd,
                    myRentPhaseResult.total_Cash,
                    myRentPhaseResult.total_Stocks,
                    myRentPhaseResult.rate_Cash,
                    myRentPhaseResult.rateStocks_ExcludedTaxes_GoodCase,
                    lifeAssumptions.rentPhase_InterestRate_Stocks_GoodCase,
                    lifeAssumptions.rentPhase_InterestRate_Cash,
                    myRentPhaseResult.taxesPerYear_GoodCase,
                    protocolWriter);

        //var rentStartStrategy = new RentStartStrategy(
        //    portfolio,
        //    rentPhase,
        //    protocolWriter);

        //rentStartStrategy.Process();



        //portfolio.Process();

        resultRows = protocolWriter.Protocol;





        // RESULTS
        // !! this part must come AFTER all calculations are done, otherwise the UI-bindings wont work !!
        Field_RentPhaseResult_GoodCase_RateCash = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.rate_Cash);
        Field_RentPhaseResult_GoodCase_RateStocks = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.rateStocks_ExcludedTaxes_GoodCase);
        Field_RentPhaseResult_GoodCase_Taxes = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.taxesPerYear_GoodCase);
        Field_RentPhaseResult_BadCase_RateCash = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.rate_Cash);
        Field_RentPhaseResult_BadCase_RateStocks = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.rateStocks_ExcludedTaxes_BadCase);
        Field_RentPhaseResult_BadCase_Taxes = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.taxesPerYear_BadCase);
        Field_RentPhaseResult_SavingsNeededCash = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.total_Cash);
        Field_RentPhaseResult_SavingsNeededStocks = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.total_Stocks);
        Field_RentPhaseResult_SavingsNeededTotal = BeautifyToCurrenctWith0Decimals(myRentPhaseResult.total_Cash + myRentPhaseResult.total_Stocks);

        FieldNeedsRentStartMinimum_perMonth = BeautifyToCurrenctWith0Decimals(myLaterNeedsResult.needsMinimum_AgeRentStart_WithInflation_PerMonth);
        FieldNeedsRentStartComfort_perMonth = BeautifyToCurrenctWith0Decimals(myLaterNeedsResult.needsComfort_AgeRentStart_WithInflation_PerMonth);
        FieldNetRentAgeFromStopWork_perMonth = BeautifyToCurrenctWith0Decimals(myStateRentResult.assumedStateRent_FromStopWorkAge_PerMonth);


        //results
        //int index = FieldAgeStopWork - FieldAgeCurrent;
        //double TotalSavingStopWorkAge = portfolio.Total.Protocol[index].yearBegin;  //resultRows[index].total.yearBegin;
        //FieldResultsTotalSavingStopWorkAge = BeautifyToCurrenctWith0Decimals(TotalSavingStopWorkAge);
        //double approxStopWorkAgeNetRent = RentSimMath.RentStopWorkAgeApproximation(FieldAgeCurrent, FieldAgeStopWork, FieldAgeRentStart, FieldNetStateRentFromCurrentAge, FieldNetStateRentFromRentStartAge);
        //FieldResultsNetStateRent = BeautifyToCurrenctWith0Decimals(approxStopWorkAgeNetRent);

        //double averageGrowthRate = portfolio.GetAverageGrowthRate();
        //(double ratePhaseRent, double ratePhaseStopWork) = SparkassenFormel.CalculatePayoutRateWithRent(
        //    startCapital: TotalSavingStopWorkAge,
        //    yearsStopWorkPhase: FieldAgeRentStart - FieldAgeStopWork,
        //    yearsRentPhase: FieldAgeEnd - FieldAgeRentStart,
        //    interestRate: averageGrowthRate,
        //    endCapital: 0,
        //    rent: approxStopWorkAgeNetRent,
        //    calcTaxes: portfolio.WithdrawalStrategy.SimulateTaxesAtWithdrawal
        //);

        //portfolio.WithdrawalStrategy.Calculate();
        //var withdrawalResults = portfolio.WithdrawalStrategy.GetResults();
        //double ratePhaseStopWork = withdrawalResults.Total.RateStopWorkNet;
        //double ratePhaseRent = withdrawalResults.Total.RateRentStartNet;

        //FieldResultsRatePhaseRent = BeautifyToCurrenctWith0Decimals(ratePhaseRent/12d);
        //FieldResultsRatePhaseStopWork = BeautifyToCurrenctWith0Decimals(ratePhaseStopWork/12d);


        //resultSet = new ResultSet(input, portfolio.Cash, portfolio.Stocks, portfolio.Metals, portfolio.Total);
        //resultRows = resultSet.ProcessAssets();
        //resultRows = rSet.ProcessAssets();//.OrderByDescending(x => x.age).ToList();


        //todo: add end amount of last result row to show it in chart

        string[] labels = Enumerable.Range(lifeAssumptions.ageRentStart, lifeAssumptions.ageEnd - lifeAssumptions.ageRentStart)
            .Select(x => x.ToString())
            .ToArray();

        //LineChartDataset<double> data = new LineChartDataset<double>
        //{
        //    BackgroundColor = new List<string> { ChartColor.FromRgba(51, 153, 102, 0.5f) },
        //    Label = "Total",
        //    BorderColor = new List<string> { ChartColor.FromRgba(51, 153, 102, 1f) },
        //    Fill = true,
        //    PointRadius = 2,
        //    BorderDash = new List<int> { },
        //    //Data = resultRows.Select(x => x.total.yearBegin).ToList(),
        //    Data = portfolio.Total.Protocol.Select(x => x.yearBegin).ToList(),
        //};

        BarChartDataset<decimal> dataBarChartCash = new BarChartDataset<decimal>
        {
            BackgroundColor = Enumerable.Repeat<string>(ChartColor.FromRgba(255, 0, 0, 0.5f), resultRows.Count()).ToList<string>(),
            Label = "Cash",
            BorderColor = Enumerable.Repeat<string>(ChartColor.FromRgba(255, 0, 0, 1f), resultRows.Count()).ToList<string>(),
            Data = resultRows.Select(x => x.cashYearBegin).ToList(),
        };

        BarChartDataset<decimal> dataBarChartStocks = new BarChartDataset<decimal>
        {
            BackgroundColor = Enumerable.Repeat<string>(ChartColor.FromRgba(0, 0, 255, 0.5f), resultRows.Count()).ToList<string>(),
            Label = "Stocks",
            BorderColor = Enumerable.Repeat<string>(ChartColor.FromRgba(0, 0, 255, 1f), resultRows.Count()).ToList<string>(),
            Data = resultRows.Select(x => x.stocksYearBegin).ToList(),
        };
        //todo: hier wirklich yearBegin oder sollte es yearEnd sein?

        //BarChartDataset<double> dataBarChartMetals = new BarChartDataset<double>
        //{
        //    BackgroundColor = Enumerable.Repeat<string>(ChartColor.FromRgba(255, 215, 0, 0.5f), portfolio.Metals.Protocol.Count).ToList<string>(),
        //    Label = "Metals",
        //    BorderColor = Enumerable.Repeat<string>(ChartColor.FromRgba(255, 215, 0, 1f), portfolio.Metals.Protocol.Count).ToList<string>(),
        //    Data = portfolio.Metals.Protocol.Select(x => x.yearBegin).ToList(),
        //};


        BarChartOptions dataBarChartOptions = new BarChartOptions()
        {
            Scales = new ChartScales
            {
                X = new ChartAxis { Stacked = true },
                Y = new ChartAxis { Stacked = true }
            },
        };

        //dataLineChartOptions = new LineChartOptions()
        //{
        //    Scales = new ChartScales
        //    {
        //        X = new ChartAxis { Stacked = true },
        //        Y = new ChartAxis { Stacked = true }

        //    },
        //};

        //myScales = new ChartScales
        //{
        //    X = new ChartAxis { Stacked = true },
        //    Y = new ChartAxis { Stacked = true }
        //};

        //await lineChart.Clear();
        //await lineChart.AddLabelsDatasetsAndUpdate(labels, data);

        barChart.Clear();
        barChart.AddLabelsDatasetsAndUpdate(labels, dataBarChartCash, dataBarChartStocks/*, dataBarChartMetals*/);

    }
}